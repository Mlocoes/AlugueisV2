<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Alugu√©is - Unificado</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sistema Alugu√©is">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- Custom CSS Unificado -->
    <link href="css/responsive.css" rel="stylesheet">
    <link href="css/animations.css" rel="stylesheet">

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white;">
        <div class="loading-spinner" style="width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%;"></div>
        <h3 style="margin-top: 1rem;">üè† Sistema de Alugu√©is</h3>
        <p>Carregando aplica√ß√£o...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9998;">
        <div class="container d-flex justify-content-center align-items-center min-vh-100">
            <div class="card shadow-lg" style="width: 100%; max-width: 400px;">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div style="font-size: 3rem;">üè†</div>
                        <h4 class="mt-2">Sistema de Alugu√©is</h4>
                        <p class="text-muted">Fa√ßa login para continuar</p>
                    </div>
                    
                    <div id="login-alert" class="alert alert-danger" style="display: none;" role="alert"></div>
                    
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-usuario" class="form-label">Usu√°rio</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                <input type="text" class="form-control" id="login-usuario" name="usuario" required autocomplete="off">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="login-senha" class="form-label">Senha</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="password" class="form-control" id="login-senha" name="senha" required autocomplete="off">
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="login-submit">
                                <i class="fas fa-sign-in-alt me-2"></i>Entrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="app-container" style="display: none;">
        <!-- Navigation Container (ser√° poblado por JavaScript) -->
        <div id="navigation-container"></div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link d-md-none me-2" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="mb-0" id="page-title">Dashboard</h4>
                </div>
                <div class="d-flex align-items-center">
                    <div class="user-info me-3" id="header-user-info">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>
                            Carregando...
                        </small>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="d-none d-md-inline ms-1">Sair</span>
                    </button>
                </div>
            </header>

            <!-- Main Body -->
            <main class="main-body" id="main-content">
                <!-- Conte√∫do din√°mico ser√° cargado aqu√≠ -->
                <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <div class="mt-3">Inicializando aplica√ß√£o...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modales (ser√£o adicionados dinamicamente conforme necess√°rio) -->
        <div id="modals-container">
            <!-- Modal Alias -->
            <div class="modal fade" id="modal-alias" tabindex="-1" aria-labelledby="modalAliasLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="modalAliasLabel"><i class="fas fa-edit me-2"></i>Editar Alias</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-2" style="font-size: 0.85rem; max-height: 60vh; overflow-y: auto;">
                            <div id="alias-alerts"></div>
                            <form id="form-alias">
                                <div class="mb-3">
                                    <label for="alias-nome" class="form-label">Nome do Alias</label>
                                    <input type="text" class="form-control" id="alias-nome" name="alias-nome" required>
                                </div>
                                <div class="mb-3">
                                    <label for="alias-proprietarios" class="form-label">Propriet√°rios</label>
                                    <select multiple class="form-select" id="alias-proprietarios" name="alias-proprietarios"></select>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="btn-salvar-alias">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Modal Alias -->
                <!-- Modal Transferencias -->
                <div class="modal fade" id="modal-transferencias" tabindex="-1" aria-labelledby="modalTransferenciasLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="modalTransferenciasLabel"><i class="fas fa-exchange-alt me-2"></i>Editar Transfer√™ncia</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-2" style="font-size: 0.85rem; max-height: 60vh; overflow-y: auto;">
                                <div id="transferencia-alerts"></div>
                                <form id="form-transferencias">
                                    <div class="mb-1">
                                        <label for="transferencia-alias" class="form-label">Selecionar Alias *</label>
                                        <select class="form-select" id="transferencia-alias" name="alias_id" required style="font-size:0.85em;">
                                            <option value="">Selecione um alias...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="transferencia-nome" class="form-label">Nome da Transfer√™ncia *</label>
                                        <input type="text" class="form-control" id="transferencia-nome" name="nome_transferencia" placeholder="Digite o nome da transfer√™ncia" required style="font-size:0.85em;">
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="transferencia-data-criacao" class="form-label">Data Cria√ß√£o *</label>
                                            <input type="date" class="form-control" id="transferencia-data-criacao" name="data_criacao" required style="font-size:0.85em;">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="transferencia-data-fim" class="form-label">Data Fim</label>
                                            <input type="date" class="form-control" id="transferencia-data-fim" name="data_fim" style="font-size:0.85em;">
                                        </div>
                                    </div>
                                    <div id="transferencia-proprietarios-container" style="display: none;">
                                        <label class="form-label">Propriet√°rios</label>
                                        <table class="table table-sm table-bordered" style="font-size:0.80em;">
                                            <thead><tr><th>Nome</th><th>Participa√ß√£o</th></tr></thead>
                                            <tbody id="transferencia-proprietarios-table"></tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary" id="btn-salvar-transferencias">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Fin Modal Transferencias -->
                                <!-- Modal Confirmar Exclus√£o Extras -->
                                <div class="modal fade" id="modal-confirmar-exclusao-extras" tabindex="-1" aria-labelledby="modalConfirmarExclusaoExtrasLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title" id="modalConfirmarExclusaoExtrasLabel"><i class="fas fa-trash me-2"></i>Confirmar Exclus√£o</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="mb-3" id="modal-confirmar-exclusao-extras-msg">Tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="button" class="btn btn-danger" id="btn-confirmar-exclusao-extras"><i class="fas fa-trash me-1"></i> Excluir</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Fin Modal Confirmar Exclus√£o Extras -->
                                </div>

    <!-- Scripts -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Core Scripts -->
    <script src="js/utils/security.js"></script>
    <script src="js/core/config.js"></script>
    <script src="js/core/network-config.js"></script>
    <script src="js/core/device-manager.js"></script>
    <script src="js/core/navigator.js"></script>
    <script src="js/core/view-manager.js"></script>
    <script src="js/core/table-manager.js"></script>
    
    <!-- Services Scripts -->
    <script src="js/apiService.js"></script>
    <script src="js/services/authService.js"></script>
    <script src="js/core/ui-manager.js"></script>
    <script src="js/core/modal-manager.js"></script>
    
    <!-- Module Scripts -->
    <script src="js/modules/loginManager.js"></script>
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/proprietarios.js"></script>
    <script src="js/modules/imoveis.js"></script>
    <script src="js/modules/participacoes.js"></script>
    <script src="js/modules/alugueis.js"></script>
    <script src="js/modules/relatorios.js"></script>
    <script src="js/modules/extras.js"></script>
    <script src="js/modules/importacao.js"></script>
    <script src="js/modules/usuarioManager.js"></script>

    <!-- Main App Script -->
    <script>
        /**
         * Aplicaci√≥n Principal Unificada
         */
        class UnifiedApp {
            constructor() {
                this.isInitialized = false;
                this.isAuthenticated = false;
                this.currentUser = null;
            }

            async init() {
                if (this.isInitialized) return;

                console.log('üöÄ Inicializando aplicaci√≥n unificada...');

                try {
                    // Limpiar localStorage corrupto al inicio
                    this.cleanupLocalStorage();

                    // Inicializar device manager
                    if (window.deviceManager) {
                        window.deviceManager.applyDeviceConfiguration();
                        window.deviceManager.setupResponsiveListeners();
                    }

                    // Verificar autenticaci√≥n guardada
                    await this.checkSavedAuth();

                    // Si no est√° autenticado, mostrar login
                    if (!this.isAuthenticated) {
                        this.showLogin();
                    } else {
                        this.showApp();
                    }

                    this.setupEventListeners();
                    this.isInitialized = true;

                } catch (error) {
                    console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                    this.showError('Error al inicializar la aplicaci√≥n');
                }
            }

            cleanupLocalStorage() {
                try {
                    const userData = localStorage.getItem('userData');
                    if (userData === 'undefined' || userData === 'null' || userData === '') {
                        console.log('üßπ Limpiando localStorage corrupto');
                        localStorage.removeItem('userData');
                        localStorage.removeItem('token');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error limpiando localStorage:', error);
                }
            }

            async checkSavedAuth() {
                const token = localStorage.getItem('token');
                const userData = localStorage.getItem('userData');

                if (token && userData && userData !== 'undefined' && userData !== 'null') {
                    try {
                        // Primero restaurar los datos en el authService
                        const authService = window.authService;
                        if (authService && authService.restoreFromLocalStorage()) {
                            // Luego validar el token
                            const isValid = await authService.validateToken();
                            if (isValid) {
                                this.isAuthenticated = true;
                                this.currentUser = JSON.parse(userData);
                                console.log('‚úÖ Autentica√ß√£o restaurada exitosamente');
                                return true;
                            } else {
                                // Si no es v√°lido, verificar si authService a√∫n tiene datos
                                // Si los tiene, es problema de conectividad, no limpiar
                                if (authService.isAuthenticated()) {
                                    console.log('üîÑ Token no validado pero datos locales presentes, continuando sin validaci√≥n');
                                    this.isAuthenticated = true;
                                    this.currentUser = JSON.parse(userData);
                                    return true;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error en autenticaci√≥n autom√°tica:', error);
                    }
                }

                // Solo limpiar si realmente no hay datos v√°lidos
                console.log('üîÑ Requiere nuevo login');
                return false;
            }

            showLogin() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('app-container').style.display = 'none';
            }

            showApp() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';

                // Inicializar componentes de la aplicaci√≥n
                this.initializeAppComponents();
            }

            showError(message) {
                document.getElementById('loading-screen').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4>Error</h4>
                        <p>${SecurityUtils.escapeHtml(message)}</p>
                        <button class="btn btn-light" onclick="location.reload()">
                            <i class="fas fa-refresh me-2"></i>Recargar
                        </button>
                    </div>
                `;
            }

            async initializeAppComponents() {
                try {
                    // Inicializar navegador
                    if (window.unifiedNavigator) {
                        window.unifiedNavigator.init();
                    }

                    // Inicializar view manager
                    if (window.viewManager) {
                        window.viewManager.init();
                    }

                    // Actualizar informaci√≥n del usuario
                    this.updateUserInfo();

                    // Navegar a la vista inicial
                    const initialView = window.unifiedNavigator ? 
                        window.unifiedNavigator.getViewFromURL() : 'dashboard';
                    
                    if (window.unifiedNavigator) {
                        window.unifiedNavigator.navigateTo(initialView);
                    }

                } catch (error) {
                    console.error('‚ùå Error inicializando componentes:', error);
                }
            }

            setupEventListeners() {
                // Login form
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.handleLogin(e.target);
                    });
                }

                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        this.handleLogout();
                    });
                }

                // Menu toggle (mobile)
                const menuToggle = document.getElementById('menu-toggle');
                if (menuToggle) {
                    menuToggle.addEventListener('click', () => {
                        if (window.unifiedNavigator) {
                            window.unifiedNavigator.toggleSidebar();
                        }
                    });
                }
            }

            async handleLogin(form) {
                const submitBtn = document.getElementById('login-submit');
                const alertDiv = document.getElementById('login-alert');
                
                try {
                    // Mostrar loading
                    submitBtn.disabled = true;
                    SecurityUtils.setSafeHTML(submitBtn, '<i class="fas fa-spinner fa-spin me-2"></i>Entrando...');
                    alertDiv.style.display = 'none';

                    const formData = new FormData(form);
                    const credentials = {
                        usuario: formData.get('usuario'),
                        senha: formData.get('senha')
                    };

                    // Realizar login a trav√©s del authService
                    const authService = window.authService;
                    if (!authService) {
                        throw new Error('Servicio de autenticaci√≥n no disponible');
                    }

                    const response = await authService.login(credentials.usuario, credentials.senha);
                    
                    if (response.success) {
                        this.isAuthenticated = true;
                        this.currentUser = {
                            usuario: response.usuario,
                            tipo: response.tipo
                        };
                        
                        // Guardar en localStorage
                        localStorage.setItem('token', response.token);
                        localStorage.setItem('userData', JSON.stringify(this.currentUser));
                        
                        // Mostrar aplicaci√≥n
                        this.showApp();
                    } else {
                        throw new Error(response.message || 'Credenciales inv√°lidas');
                    }

                } catch (error) {
                    console.error('‚ùå Error en login:', error);
                    alertDiv.textContent = error.message || 'Error al iniciar sesi√≥n';
                    alertDiv.style.display = 'block';
                } finally {
                    // Restaurar bot√≥n
                    submitBtn.disabled = false;
                    SecurityUtils.setSafeHTML(submitBtn, '<i class="fas fa-sign-in-alt me-2"></i>Entrar');
                }
            }

            handleLogout() {
                // Limpiar datos
                localStorage.removeItem('token');
                localStorage.removeItem('userData');
                this.isAuthenticated = false;
                this.currentUser = null;

                // Mostrar login
                this.showLogin();
            }

            updateUserInfo() {
                if (!this.currentUser) return;

                const userInfo = document.getElementById('header-user-info');
                if (userInfo) {
                    SecurityUtils.setSafeHTML(userInfo, `
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>
                            ${SecurityUtils.escapeHtml(this.currentUser.usuario)} (${SecurityUtils.escapeHtml(this.currentUser.tipo)})
                        </small>
                    `);
                }

                // Actualizar en navegador tambi√©n
                if (window.unifiedNavigator) {
                    window.unifiedNavigator.updateUserInfo(this.currentUser);
                }
            }
        }

        // Inicializar aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            window.unifiedApp = new UnifiedApp();
            window.unifiedApp.init();
        });
    </script>
</body>
</html>
